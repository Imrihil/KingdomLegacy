@page "/"

<PageTitle>Kingdom Legacy</PageTitle>

@if (GameContext == null)
{
    <lead>What do you want to do?</lead>

    <div class="d-flex flex-column mb-3">
        <Button class="m-2" Type="ButtonType.Button" Color="ButtonColor.Primary">
            <InputFile title="Load game" OnChange="LoadGame" />
        </Button>
        <Button class="m-2" Type="ButtonType.Link" Color="ButtonColor.Primary" @onclick=NewGame>New game</Button>
    </div>
}
else
{
    <div class="d-flex flex-row flex-wrap mb-3">
        <div class="d-flex flex-column rounded text-bg-secondary">
            <p>Box (<span>@GameContext.BoxCount</span>)</p>
            <Button class="p-1" Type="ButtonType.Button" Color="ButtonColor.Primary" @onclick="() => GameContext?.AddToDeck()">
                <p>+1</p>
            </Button>
            <Button class="p-1" Type="ButtonType.Button" Color="ButtonColor.Primary" @onclick="() => GameContext?.AddToDeck(2)">
                <p>+2</p>
            </Button>
            <Button class="p-1" Type="ButtonType.Button" Color="ButtonColor.Primary" @onclick="() => GameContext?.AddToDeck(5)">
                <p>+5</p>
            </Button>
            <Button class="p-1" Type="ButtonType.Button" Color="ButtonColor.Primary" @onclick="() => GameContext?.AddToDeck(10)">
                <p>+10</p>
            </Button>
        </div>
        <div class="pe-2 position-relative to-hover" id="deck">
            <GameCard CardContext="@GameContext.DeckTop" />
            <div class="w-100 h-100 position-absolute top-0 start-0" style="background-color: #404040A0;"></div>
            <div class="m-0 p-0 position-absolute top-50 start-50 translate-middle to-show">
                <Button class="m-1 p-1 rounded-circle" Type="ButtonType.Button" Color="ButtonColor.Success" Position="Position.Relative" @onclick="() => GameContext?.Draw()">
                    +1
                </Button>
                <Button class="m-1 p-1 rounded-circle" Type="ButtonType.Button" Color="ButtonColor.Success" Position="Position.Relative" @onclick="() => GameContext?.Draw(2)">
                    +2
                </Button>
                <Button class="m-1 p-1 rounded-circle" Type="ButtonType.Button" Color="ButtonColor.Success" Position="Position.Relative" @onclick="() => GameContext?.Draw(4)">
                    +4
                </Button>
                <Button class="m-1 p-1 rounded-circle" Type="ButtonType.Button" Color="ButtonColor.Danger" Position="Position.Relative" @onclick="() => GameContext?.Reshuffle()">
                    ♺
                </Button>
                <Button class="m-1 p-1 rounded-circle" Type="ButtonType.Button" Color="ButtonColor.Info" Position="Position.Relative" Disabled="true">
                    @GameContext.DeckCount
                </Button>
            </div>
        </div>
        @foreach (var card in GameContext.Hand)
        {
            <div class="pe-2 position-relative to-hover" id="deck">
                <GameCard CardContext="@card" />
                <div class="w-100 h-100 position-absolute top-0 start-0" style="background-color: #404040A0;"></div>
                <div class="m-0 p-0 position-absolute top-50 start-50 translate-middle to-show">
                    <Button class="m-1 p-1 rounded-circle" Type="ButtonType.Button" Color="ButtonColor.Success" Position="Position.Relative" @onclick="() => GameContext?.Discard(card)">
                        ✓
                    </Button>
                    <Button class="m-1 p-1 rounded-circle" Type="ButtonType.Button" Color="ButtonColor.Success" Position="Position.Relative" @onclick="() => card.RotateRight()">
                        ⇒
                    </Button>
                    <Button class="m-1 p-1 rounded-circle" Type="ButtonType.Button" Color="ButtonColor.Success" Position="Position.Relative" @onclick="() => card.RotateDown()">
                        ⇓
                    </Button>
                    <Button class="m-1 p-1 rounded-circle" Type="ButtonType.Button" Color="ButtonColor.Danger" Position="Position.Relative" @onclick="() => GameContext?.Trash(card)">
                        x
                    </Button>
                </div>
            </div>
        }
        @foreach (var card in GameContext.InPlay)
        {
            <div class="pe-2 position-relative to-hover" id="deck">
                <GameCard CardContext="@card" />
                <div class="w-100 h-100 position-absolute top-0 start-0" style="background-color: #404040A0;"></div>
                <div class="m-0 p-0 position-absolute top-50 start-50 translate-middle to-show">
                    <Button class="m-1 p-1 rounded-circle" Type="ButtonType.Button" Color="ButtonColor.Success" Position="Position.Relative" @onclick="() => GameContext?.Discard(card)">
                        ✓
                    </Button>
                    <Button class="m-1 p-1 rounded-circle" Type="ButtonType.Button" Color="ButtonColor.Success" Position="Position.Relative" @onclick="() => card.RotateRight()">
                        ⇒
                    </Button>
                    <Button class="m-1 p-1 rounded-circle" Type="ButtonType.Button" Color="ButtonColor.Success" Position="Position.Relative" @onclick="() => card.RotateDown()">
                        ⇓
                    </Button>
                    <Button class="m-1 p-1 rounded-circle" Type="ButtonType.Button" Color="ButtonColor.Danger" Position="Position.Relative" @onclick="() => GameContext?.Trash(card)">
                        x
                    </Button>
                </div>
            </div>
        }
    </div>
}

@code {
    [Parameter]
    public KingdomLegacy.Domain.Game? GameContext { get; set; }

    private void LoadGame(InputFileChangeEventArgs args)
    {
        GameContext = new KingdomLegacy.Domain.Game();
        using var stream = args.File.OpenReadStream();
        using var reader = new StreamReader(stream);

        GameContext.Load(Read(reader));
    }

    private IEnumerable<string> Read(StreamReader reader)
    {
        while (reader.Peek() >= 0)
        {
            var line = reader.ReadLine();
            if (line != null)
                yield return line;
        }
    }

    private void NewGame(MouseEventArgs args)
    {
        if (GameContext == null)
        {
            GameContext = new KingdomLegacy.Domain.Game();
            GameContext.Initialize(Expansions.FeudalKingdom);
        }
    }
}